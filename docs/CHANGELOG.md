# 变更日志

本文件记录了本项目在本次重构/优化周期内的主要变更、动机与影响。

## 2025-09-29

### 后端
- 统一标签作用域：所有标注合并与导出逻辑，优先按数据集过滤标签，无则回退通用标签（dataset_id: null/缺失）。
- 稳定随机取图：基于“用户+数据集”生成稳定随机序列，用于：
  - /api/images_with_annotations 的未标注子集排序（include_all=true 时未标注在前、已标注在后）。
  - /api/next_image 选择下一张未标注图。
- 导出逻辑：当 expert_id=admin（不区分大小写）时，导出该数据集所有用户标注；标签表按数据集过滤。
- 修复标签创建时 ObjectId 序列化错误：插入与返回对象分离，返回内容不含 _id。
- 旧路由下线：
  - 支持通过环境变量 DISABLE_LEGACY_ROUTES=1 禁用旧路由。
  - 注册顺序调整为“先旧后新”，新蓝图覆盖同名接口；随后物理删除 `backend/app/routes.py`。

### 前端
- 标注流程优化：
  - 初次取图与提交后取图，优先使用仅未标注列表（include_all=false）或 /next_image，遵循后端稳定随机顺序。
  - 提交按钮三态：未选标签（灰）/提交中（橙）/可提交（蓝），提交完成立即恢复蓝色状态。
- 样式增强：新增 .btn.pending 与更明确的禁用样式。

### 文档
- 新增 `docs/CHANGELOG.md` 记录变更。
- 标注 legacy 路由状态：代码仍保留 `backend/app/routes.py`，推荐通过 `DISABLE_LEGACY_ROUTES=1` 禁用，生产由新蓝图完全接管。

## 兼容性与迁移
- 若前端仍使用旧接口路径，与新蓝图保持兼容；建议统一迁移到新 API（app/api/*）。
- 如需恢复旧路由，可临时注释删除并移除 DISABLE_LEGACY_ROUTES 环境变量，但不建议长期依赖旧实现。
